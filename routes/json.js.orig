var express = require('express');
var router = express.Router();
var util = require('../bin/utilities.js');
var _API = require('../api/main.js');
var _Config = require('config');

/* JSON CALLS */
router.get('/states', function(req, res, next) {
	// Set headers for json
	util.SetAccessControl(res);

	if(req.query.countryCode){
		// Send states back to the caller
		res.end(JSON.stringify(util.getStates(req.query.countryCode)));
	}
	// If nothing was provided
  	res.end('{}');
});

router.get('/ziplookup', function(req, res, next) {
	// Set headers for json
	util.SetAccessControl(res);

	if(req.query.zip){
		var callback = function(err,result){
			if(err){
				console.log('error ' + err);
				res.end('{}');
			}else{
				if(result.city&&result.state){
					console.log('not');
					res.end(JSON.stringify(result));
				}
			}
		}

		GetCityStateInfo(req.query.zip,callback);
	}else{
		// If nothing was provided
	  	res.end('{}');
	  }
});

router.get('/lead', function(req, res, next) {
	// Set headers for json
	util.SetAccessControl(res);

    
    
    if (req.query.shippingfirst) {
        
        var configCRM = _Config.get('CRM');
        
        var newData = {
            token: configCRM.apikey,// '2387eec8-036b-4ff9-87f4-1cd33a3b5323',
            storeid: configCRM.storeid,
            
            offer: configCRM.defaults.offer,//  'Active Garcinia &Cambogia',
            saleorigin: 'someSite.com',
            leadType: configCRM.leadtypeid, // 'S_LeadType',
            affcode: configCRM.defaults.campaignCode, // 'S_Campaign',
            
            sfirstname: req.query.shippingfirst || "",
            slastname: req.query.shippinglast || "",
            saddress1: req.query.shippingaddress1 || "",
            scity: req.query.shippingcity || "",
            sstate: req.query.shippingstate || "",
            scountry: req.query.shippingcountry || "US", //TODO: add country
            szipcode: req.query.shippingzip || "",
            phonenumber: req.query.shippingphone || "",
            email: req.query.shippingemail || "",
            //clientip: req.query.shippingfirst || "", TODO: Add Phone
            
            _res: res,
            _next: "/order",
            callback : ProcessAPIResponse
        };
    
        _API.AddPartial(newData);

	}else{
		// If nothing was provided
	  	// res.end('{}');
	  }
});

router.get('/sale', function(req, res, next) {
	// Set headers for json
	util.SetAccessControl(res);

	if(req.query.sfirst){
		// Update session
		req.session.purchased = 1;
        
        var configCRM = _Config.get('CRM');
        var configOrderPage = _Config.get('ORDERPAGE');
        
        
        var idxProduct = req.query.product || 0;
        if (idxProduct >= configOrderPage.products.length) { 
            idxProduct = 0;
        }

        var newData = {
            token: configCRM.apikey,// '2387eec8-036b-4ff9-87f4-1cd33a3b5323',
            storeid: configCRM.storeid,
            
            offer: configCRM.defaults.offer,//  'Active Garcinia &Cambogia',
            saleorigin: 'someSite.com',
            //leadType: configCRM.leadtypeid, // 'S_LeadType',
            affcode: configCRM.defaults.campaignCode, // 'S_Campaign',
            
            sfirstname: req.query.shippingfirst || "",
            slastname: req.query.shippinglast || "",
            saddress1: req.query.shippingaddress1 || "",
            scity: req.query.shippingcity || "",
            sstate: req.query.shippingstate || "",
            scountry: req.query.shippingcountry || "US", //TODO: add country
            szipcode: req.query.shippingzip || "",
            phonenumber: req.query.shippingphone || "",
            email: req.query.shippingemail || "",
            //clientip: req.query.shippingfirst || "", TODO: Add Phone
            
            pid : configOrderPage.products[idxProduct].packageId,
            bsameasshipping : req.query.sameShipping || true,
            
            
            bfirstname: req.query.billingfirst || "",
            blastname: req.query.billinglast || "",
            baddress1: req.query.billingaddress1 || "",
            bcity: req.query.billingcity || "",
            bstate: req.query.billingstate || "",
            bcountry: req.query.billingcountry || "US", //TODO: add country
            bzipcode: req.query.billingzip || "",
            
            cardnumber : req.query.cardnumber || "",
            expirymonth : req.query.expirymonth || 1,
            expiryyear : req.query.expiryyear || 2000,
            cardcvv : req.query.cvv | "",
            
            test : true,// false;
            
            misc1 : req.query.misc1 || "",
            misc2 : req.query.misc2 || "",
            misc3 : req.query.misc3 || "",
            
            mid : req.query.mid || "",
            loadbalancegroup : req.query.loadbalancegroup || "",

            //products = [],
            
            _res: res,
            _next: "/thankyou",
            callback : ProcessAPIResponse
        };
        
        _API.Sale(newData);
        
	}else{
		// If nothing was provided
	  	res.end('{}');
	  }
});


function ProcessAPIResponse(err, data, res) {
    if (err) {
        data = {
            success : false,
            message : err
        }
    }
    
    res.end(JSON.stringify(data));
}


function GetCityStateInfo(zipcode,callback) {
			var  userId = "017HERIM0038";
		    var zip5 = zipcode
		    var array = zip5.split("-");
		    var city = "";
		    var state = "";
		    var valid = false;

		    if (array.length > 1) {
		        zip5 = array[0];
		    }

		    var url = "http://production.shippingapis.com/";
		    xml2js = require('xml2js');
		    http = require('http');

		    var postRequest = {
			    host: "production.shippingapis.com",
			    path: "/ShippingAPI.dll?API=CityStateLookup&XML=" + encodeURIComponent("<CityStateLookupRequest USERID=\"" + userId + "\"><ZipCode ID= \"0\"><Zip5>" + zip5 + "</Zip5></ZipCode></CityStateLookupRequest>"),
			    port: 80,
			    method: "GET"
			};

			var buffer = "";

			var req = http.request( postRequest, function( res ){
			    var buffer = "";
			    res.on( "data", function( data ) { buffer = buffer + data; } );

			   	res.on( "end", function( data ) { 
			   		var parseString = require('xml2js').parseString;
			   		// console.log( buffer ); 
			   		parseString(buffer, function (err, result) {
			   			// Retrieve data
			   			if(!err){
			   				if(result.CityStateLookupResponse)
			   					if(result.CityStateLookupResponse.ZipCode){
			   						if(result.CityStateLookupResponse.ZipCode.length>0){
										var results = result.CityStateLookupResponse.ZipCode[0];
										if(results.City)
											if(results.City.length>0)
												city = results.City[0];
										if(results.State)
											if(results.State.length>0)
												state = results.State[0];
										callback(null,{city:city,state:state});
			   						}
			   					}
			   			}else{
			   				callback(err);
			   			}
					});
			    });

			});

			req.write('');
			req.end();

		    // $.get(url, {
		    //         API: "CityStateLookup",
		    //         XML: "<CityStateLookupRequest USERID=\"" + userId + "\"><ZipCode ID= \"0\"><Zip5>" + zip5 + "</Zip5></ZipCode></CityStateLookupRequest>"
		    //     },
		    //     function(data) {
		    //          $(data).find("ZipCode").each(function() {
		    //             var zipCode = $(this);
		    //             if ((zipCode.find("City").text()) != "") {
		    //                 city = zipCode.find("City").text();
		    //                 state = zipCode.find("State").text();
		    //                 valid = true;
		    //             }
		    //             callback({valid: valid, city: city, state: state});
		    //         });
		    //  });

	}


module.exports = router;